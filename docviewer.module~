<?php
require_once('docviewer.cfg');

//определяет список возможных прав
function docviewer_perm() {
  return array("access docviewer content", "administer docviewer", "access docviewer source", "create docviewer nodes", "edit docviewer nodes");
}

//определение доступа к функциям
function docviewer_access($op, $node, $account) {
  if ($op == 'create') {
    return user_access('create docviewer nodes', $account);
  }
  if ($op == 'update' || $op == 'delete') {
    return user_access('edit docviewer nodes', $account);
  }
}

//вывод справки
function docviewer_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/help#docviewer":
      $output = '<p>'. t("Display interface for viewing docs (now only pdf)") .'</p>';
      break;
  }
  return $output;
}

//страница администрирования
function docviewer_admin() {
  $form = array();
  $form['docviewer_header'] = array(
    '#type' => 'textfield',
    '#title' => t('Default header'),
    '#default_value' => variable_get('docviewer_header', 'DocViewer'),
    '#size' => 20,
    '#maxlength' => 30,
    '#description' => t("Default header of document navigator"),
    '#required' => TRUE,
  );
  return system_settings_form($form);
}

//ссылка в меню
function docviewer_menu() {
  $items = array();
  $items['admin/settings/docviewer'] = array(
    'title' => t('DocViewer settings'),
    'description' => t('Settings for DocViewer'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('docviewer_admin'),
    'access arguments' => array('administer docviewer'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/content/docviewer'] = array(
    'title' => t('DocViewer documents'),
    'description' => t('Add and delete documents from list'),
    'page callback' => 'docviewer_edit_list',
    'access arguments' => array('administer docviewer'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['doc/%/%'] = array(
    'page callback' => '_document_get_page',
    'page arguments' => array(1, 2),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administer docviewer'),
  );
  $items['docviewer/%docviewer_document/delete'] = array(
    'title' => t('Delete document'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('docviewer_delete_confirm', 1),
    'access arguments' => array('administer docviewer'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

//создание типа публикации
function docviewer_node_info() {
  return array(
    'docviewer_page' => array(
      'name' => t('page with document'),
      'module' => 'docviewer',
      'description' => "This is node with online viewer.",
    )
  );
}

//формы при создании новой публикации
function docviewer_form(&$node, $form_state) {
  $type = node_get_types('type', $node);
  $form['title'] = array(
    '#type' => 'textfield',
    '#title' => check_plain($type->title_label),
    '#required' => TRUE,
    '#default_value' => $node->title,
    '#weight' => -5,
  );
  $form['body_filter']['body'] = array(
    '#type' => 'textarea',
    '#title' => t('Description of documents'),
    '#default_value' => $node->body,
    '#required' => FALSE,
  );
  return $form;
}

//формы
//загрузка файла на сервер
function docviewer_upload_form() {
  global $user;
  //Администратор может загружать любые файлы. Проверки отключаются
  if ($user->uid == 1) {
    drupal_set_message("You are login as admin. File validation off.", "warning");
  }
  $form = array();
  //если условие выполняется значит была попытка загрузить файл больше разрешенного размера
  if (($_SERVER['CONTENT_LENGTH'])&&(parse_size(ini_get("post_max_size")) < $_SERVER['CONTENT_LENGTH'])) {
    drupal_set_message(t("File size is larger than allowed."), 'error');
  }
  $form['#attributes'] = array('enctype' => "multipart/form-data");
  $form['upload'] = array(
    '#type' => 'file',
    '#title' => t('Upload document'),
    '#size' => 22,
    '#weight' => 0,
  );
  $form['max_filesize'] = array(
    '#type' => 'markup',
    '#value' => "<b>Max file size:</b> ". (file_upload_max_size()/1024/1024) .'MB<br>',
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save document'),
  );
  return $form;
}

//обработка данных из формы docviewer_upload
//TODO:AJAX, перенаправление на страницу с прогрессбаром
//TODO:learn drupal path build function, and rewrite function
//TODO:check mimetype
function docviewer_upload_form_submit($form, &$form_state) {
  global $_source_dir;
  global $_cache_dir;
  global $user;
  $file_ext = "pdf";
  $validators = array(
    "file_validate_extensions" => array('pdf'),
  );
  $dest = file_directory_path() .'/'. $_source_dir;
  $cache = file_directory_path() .'/'. $_cache_dir;
  //проверка директории для сохранения
  if (!file_check_directory($dest, FILE_CREATE_DIRECTORY)) {
    form_set_error('upload', t("Can't create directory for file"));
    return 1;
  }
  if (!file_check_directory($cache, FILE_CREATE_DIRECTORY)) {
    form_set_error('upload', t("Can't create directory for file"));
    return 1;
  }
  $file = file_save_upload('upload', $validators, $dest);
  //не удалось сохранить файл
  if ($file == 0) {
    form_set_error('upload', t("File saving fail."));
    return 1;
  }
  $filepath = $dest .'/'. $file->filename;
  $md5sum = md5_file($filepath);
  $result = db_query("SELECT * FROM {docviewer_documents} WHERE md5sum='%s'", $md5sum);
  if ($result->num_rows) {
    form_set_error('upload', t("File already exists"));
    return 1;
  }
  $cache_folder = file_directory_path() ."/". $_cache_dir ."/". $md5sum; 
  //не удалось создать папку для кэша
  if (!file_check_directory($cache_folder, FILE_CREATE_DIRECTORY)) {
    form_set_error('upload', "Failed create cache files folder.");
    return 1;
  }
  $pages = _docviewer_caching_document($filepath, $cache_folder);
  //Изображений не создано
  if ($pages <= 0) {
    form_set_error('upload', t("Document reading fail."));
    return 1;
  }
  //Не удалось добавить информацию о файле в базу
  if (!db_query("INSERT INTO {docviewer_documents} (filename, pages, md5sum, uid, upload_date, filesize) VALUES('%s', '%d', '%s', '%d', '%d', '%d')", $file->filename, $pages, $md5sum, $user->uid, $file->timestamp, $file->filesize)) {
    form_set_error('upload', t("Insert in database failed."));
    return 1;
  }
  $result = db_query("SELECT docid FROM {docviewer_documents} WHERE md5sum='%s'", $md5sum);
  //не удалось узнать id только что созданного документа
  if (!$result) {
    form_set_error('upload', t("Database error."));
    return 1;
  }
  $result = db_fetch_object($result);
  $source_move = $dest ."/". $result->docid; 
  //перенос документа в его папку по id
  if (!file_move($filepath, $dest ."/". $result->docid .".". $file_ext, FILE_EXISTS_ERROR)) {
    form_set_error('upload', t('Unable to transfer document'));
  }
  $cache_move = file_directory_path() .'/'. $_cache_dir .'/'. $result->docid;
  //переименование папки с кэшем
  rename($cache_folder, $cache_move);
  drupal_set_message("File ". check_plain($file->filename) ." succesfull upload.");
}

//make cache for document. return page count of document
//TODO: add check with "is_dir"
function _docviewer_caching_document($doc, $cache_folder) {
  $files = array();
  exec("pdftoppm -jpeg '". realpath($doc) ."' '". realpath($cache_folder) ."/page'");
  $files = file_scan_directory($cache_folder, "^page{1}-[0-9]+\.jpg$");
  return count($files);
}

//страница редактирования списка файлов
function docviewer_edit_list() {
  $output = "";
  $output .= drupal_get_form("docviewer_upload_form");
  $query = db_query("SELECT docid, filename, filesize, pages FROM {docviewer_documents}");
  $header = array('Id', t('Filename'), t('Size'), t('Pages'), t('Actions')); 
  $data = array();
  while ($row = db_fetch_object($query)) {
    $actions = l(t(delete), 'docviewer/'. $row->docid .'/delete', array('alias' => TRUE)); 
    $data[] = array(
      $row->docid,
      $row->filename,
      $row->filesize,
      $row->pages,
      $actions,
    );
  }
  $output .= theme_table($header, $data);
  return $output; 
}

//рекурсивное удаление папки или файла
function _rm($dir) {
 if (is_dir($dir)) {
   $objects = scandir($dir);
   foreach ($objects as $object) {
     if ($object != "." && $object != "..") {
       if (filetype($dir ."/". $object) == "dir") _rm($dir ."/". $object); else unlink($dir ."/". $object);
     }
   }
   reset($objects);
   rmdir($dir);
 }
 if (is_file($dir)) {
  unlink($dir);
 }
}

//удаление документа
function docviewer_delete_confirm_submit($form, &$form_state) {
  global $_source_dir;
  global $_cache_dir;
  $id = $form_state['values']['docid'];
  drupal_set_message("DOCID: ". $id);
  if (!db_query("DELETE FROM {docviewer_documents} WHERE docid=%d", $id)) {
    drupal_set_message(t("Delete document $id from database failed."), "error");
  }
  _rm(file_directory_path() ."/". $_source_dir ."/". $id); 
  _rm(file_directory_path() ."/". $_cache_dir ."/". $id); 
  drupal_set_message(check_plain(t('Document succesfull delete')));
  drupal_goto('admin/content/docviewer');
}

//форма подтверждения удаления
function docviewer_delete_confirm(&$form_state, $doc) {
  $form['docid'] = array(
    '#type' => 'value',
    '#value' => $doc->docid,
  );
  return confirm_form($form,
    'Вы действительно хотите удалить документ <i>' . check_plain($doc->filename) . '</i>?',
    'docviewer',
    'Эта операция не обратима',
    'Удалить',
    'Отменить'
  );
}

//проверка существования документа
function docviewer_document_load($id) {
  $result = db_query("SELECT * FROM {docviewer_documents} WHERE docid=%d", $id);
  return db_fetch_object($result);
}

function _document_get_page($id, $page) {
  global $_cache_dir;
  drupal_set_message("AAAA");
  //$output = "";
  //$output .= "<img src=\"". file_create_url(file_directory_path() ."/". $_cache_dir ."/". $id ."/page-". $page .".jpg") ."\"/>";
  //return $output;
} 
